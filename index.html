<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Meal Randomizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --border: #e5e7eb;
      --text: #111827;
      --radius: 12px;
      --shadow: 0 3px 10px rgba(0,0,0,0.06);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
      max-width: 900px;
      margin-inline: auto;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 14px;
      font-weight: 700;
    }

    h2 {
      font-size: 20px;
      margin: 0;
      font-weight: 600;
    }

    /* Karten */
    .card {
      background: var(--card-bg);
      padding: 18px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-top: 18px;
    }

    /* Inputs */
    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-sizing: border-box;
      margin-top: 6px;
    }

    button {
      width: 100%;
      padding: 11px 14px;
      font-size: 16px;
      border-radius: var(--radius);
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }

    .primary {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .secondary {
      background: #e5e7eb;
      color: #111;
      border-color: #e5e7eb;
    }

    .danger {
      background: #dc2626;
      color: #fff;
      padding: 6px 10px;
      width: auto;
      font-size: 14px;
    }

    /* Zuklappbare Titel-Leiste */
    .collapse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding-bottom: 10px;
    }

    .collapse-arrow {
      font-size: 18px;
      margin-left: 8px;
    }

    /* kompakte Ein-Zeile */
    .compact-row {
      padding: 10px 0;
      font-size: 16px;
      border-top: 1px solid var(--border);
    }

    /* volle Liste */
    .full-list {
      margin-top: 12px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px 4px 0 0;
      font-size: 12px;
      background: #e5e7eb;
      border-radius: 999px;
    }

    /* Filter-Felder */
    .filter-row {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      padding: 8px 0;
    }

    .filter-row input {
      width: 60px;
      text-align: center;
    }

    /* Plan */
    .plan {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
      margin-top: 16px;
    }

    .day {
      padding: 14px;
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .day img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: var(--radius);
      margin: 10px 0;
    }
  </style>
</head>

<body>

<h1>Meal Randomizer</h1>

<!-- ============================== -->
<!-- KARTE 1 – GERICHTE -->
<!-- ============================== -->

<div class="card" id="mealsCard">

  <div class="collapse-header" id="mealsToggle">
    <h2>Gespeicherte Gerichte</h2>
    <span id="mealsArrow" class="collapse-arrow">►</span>
  </div>

  <!-- kompakte erste Zeile -->
  <div id="mealsCompact"></div>

  <!-- komplette Liste -->
  <div id="mealsFull" class="full-list" style="display:none;"></div>

</div>

<!-- ============================== -->
<!-- KARTE 2 – RANDOMIZE NACH KATEGORIEN -->
<!-- ============================== -->

<div class="card" id="catCard">

  <div class="collapse-header" id="catToggle">
    <h2>Randomize nach Kategorien</h2>
    <span id="catArrow" class="collapse-arrow">►</span>
  </div>

  <!-- kompakte erste Zeile -->
  <div id="catCompact"></div>

  <!-- komplette Filterliste -->
  <div id="catFull" style="display:none; margin-top:12px;">
    <small>(Leer lassen = komplett zufällig)</small>
    <div id="filterFields" style="margin-top:12px;"></div>
  </div>

</div>

<!-- ============================== -->
<!-- KARTE 3 – RANDOMIZER -->
<!-- ============================== -->

<div class="card">

  <h2>Anzahl Tage für Randomizer</h2>

  <label>Anzahl Tage</label>
  <input id="days" type="number" min="1" value="5">

  <button class="primary" id="generate">Randomizer</button>
  <button class="secondary" id="export">Export als Bild</button>

  <p id="planMsg" style="font-size:13px;color:red;"></p>

  <div id="planContainer">
    <div id="plan" class="plan"></div>
  </div>

</div>

<!-- ============================== -->
<!--        JAVASCRIPT LOGIK        -->
<!-- ============================== -->

<script>
  let meals = JSON.parse(localStorage.getItem("meals") || "[]");
  let plan = [];

  const save = () => localStorage.setItem("meals", JSON.stringify(meals));

  /* ============================================================
     HILFE
  ============================================================ */
  function getAllTags() {
    const tags = new Set();
    meals.forEach(m => m.tags.forEach(t => tags.add(t)));
    return [...tags].sort();
  }

  /* ============================================================
     GERICHTE DARSTELLEN
  ============================================================ */
  function renderMeals() {
    const compact = document.getElementById("mealsCompact");
    const full = document.getElementById("mealsFull");

    if (meals.length === 0) {
      compact.innerHTML = `<div class="compact-row">Keine Gerichte vorhanden</div>`;
      full.innerHTML = "";
      renderFilterFields();
      return;
    }

    // kompakte erste Zeile
    compact.innerHTML = `<div class="compact-row">• ${meals[0].name}</div>`;

    // volle Liste
    full.innerHTML = "";
    meals.forEach(m => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div>
          <strong>${m.name}</strong><br>
          ${m.tags.map(t => `<span class="tag">${t}</span>`).join("")}
        </div>
      `;
      const del = document.createElement("button");
      del.className = "danger";
      del.textContent = "X";
      del.onclick = () => {
        meals = meals.filter(x => x.id !== m.id);
        save();
        renderMeals();
        renderFilterFields();
      };
      row.appendChild(del);
      full.appendChild(row);
    });

    renderFilterFields();
  }

  /* ============================================================
     FILTER DARSTELLEN
  ============================================================ */
  function renderFilterFields() {
    const compact = document.getElementById("catCompact");
    const full = document.getElementById("catFull");
    const container = document.getElementById("filterFields");

    const tags = getAllTags();

    if (tags.length === 0) {
      compact.innerHTML = `<div class="compact-row">Keine Kategorien vorhanden</div>`;
      container.innerHTML = "";
      return;
    }

    // kompakte erste Zeile
    compact.innerHTML = `<div class="compact-row">• ${tags[0]}</div>`;

    // volle Liste
    container.innerHTML = "";
    tags.forEach(tag => {
      const div = document.createElement("div");
      div.className = "filter-row";
      div.innerHTML = `
        <span>${tag}</span>
        <input type="number" min="0" data-tag="${tag}">
      `;
      container.appendChild(div);
    });
  }

  /* ============================================================
     RANDOMIZER
  ============================================================ */
  document.getElementById("generate").onclick = () => {
    const days = parseInt(document.getElementById("days").value);
    const planMsg = document.getElementById("planMsg");
    planMsg.textContent = "";

    if (!days || days < 1) {
      planMsg.textContent = "Bitte gültige Anzahl Tage eingeben.";
      return;
    }

    if (meals.length === 0) {
      planMsg.textContent = "Keine Gerichte vorhanden.";
      return;
    }

    // Pflichtkategorien
    const inputs = [...document.querySelectorAll("#filterFields input")];
    let desired = [];

    inputs.forEach(inp => {
      const amount = parseInt(inp.value);
      const tag = inp.dataset.tag;
      if (amount > 0) {
        for (let i = 0; i < amount; i++) desired.push(tag);
      }
    });

    // Resttage auffüllen
    while (desired.length < days) desired.push("RANDOM");

    // Überschuss ignorieren
    desired = desired.slice(0, days);

    // mischen
    desired.sort(() => Math.random() - 0.5);

    plan = [];

    desired.forEach(tag => {
      let candidates =
        tag === "RANDOM"
          ? meals
          : meals.filter(m => m.tags.includes(tag));

      if (!candidates.length) candidates = meals;

      const chosen = candidates[Math.floor(Math.random() * candidates.length)];
      plan.push({ tag, meal: chosen });
    });

    renderPlan();
  };

  /* ============================================================
     TAGE EINZELN NEU ZIEHEN
  ============================================================ */
  function reroll(i) {
    const tag = plan[i].tag;
    let candidates =
      tag === "RANDOM"
        ? meals
        : meals.filter(m => m.tags.includes(tag));
    if (!candidates.length) candidates = meals;
    plan[i].meal = candidates[Math.floor(Math.random() * candidates.length)];
    renderPlan();
  }

  /* ============================================================
     PLAN ANZEIGEN
  ============================================================ */
  function renderPlan() {
    const p = document.getElementById("plan");
    p.innerHTML = "";

    plan.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "day";
      div.innerHTML = `<strong>Tag ${idx + 1}</strong><br>`;

      if (item.meal.image)
        div.innerHTML += `<img src="${item.meal.image}">`;

      div.innerHTML += `${item.meal.name}<br>`;
      div.innerHTML += item.meal.tags.map(t => `<span class="tag">${t}</span>`).join("");

      const btn = document.createElement("button");
      btn.className = "secondary";
      btn.style.marginTop = "10px";
      btn.textContent = "Neu ziehen";
      btn.onclick = () => reroll(idx);

      div.appendChild(btn);
      p.appendChild(div);
    });
  }

  /* ============================================================
     EXPORT
  ============================================================ */
  document.getElementById("export").onclick = () => {
    if (!plan.length) return;
    html2canvas(document.getElementById("planContainer")).then(canvas => {
      const a = document.createElement("a");
      a.download = "meal-plan.png";
      a.href = canvas.toDataURL();
      a.click();
    });
  };

  /* ============================================================
     ZUKLAPPEN – GERICHTE
  ============================================================ */
  document.getElementById("mealsToggle").onclick = () => {
    const full = document.getElementById("mealsFull");
    const arrow = document.getElementById("mealsArrow");

    if (full.style.display === "none") {
      full.style.display = "block";
      arrow.textContent = "▼";
    } else {
      full.style.display = "none";
      arrow.textContent = "►";
    }
  };

  /* ============================================================
     ZUKLAPPEN – KATEGORIEN
  ============================================================ */
  document.getElementById("catToggle").onclick = () => {
    const full = document.getElementById("catFull");
    const arrow = document.getElementById("catArrow");

    if (full.style.display === "none") {
      full.style.display = "block";
      arrow.textContent = "▼";
    } else {
      full.style.display = "none";
      arrow.textContent = "►";
    }
  };

  /* INIT */
  renderMeals();
  renderFilterFields();
  renderPlan();
</script>

</body>
</html>
