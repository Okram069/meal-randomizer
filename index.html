<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Meal Randomizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --border: #e5e7eb;
      --text: #111827;
      --radius: 12px;
      --shadow: 0 3px 10px rgba(0,0,0,0.06);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
      max-width: 900px;
      margin-inline: auto;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 14px;
      font-weight: 700;
    }

    h2 {
      font-size: 20px;
      margin: 0;
      font-weight: 600;
    }

    .card {
      background: var(--card-bg);
      padding: 18px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-top: 18px;
    }

    .form-group {
      margin-top: 20px;
    }
    .form-group.first {
      margin-top: 0;
    }

    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-sizing: border-box;
      margin-top: 6px;
    }

    .checkbox-group {
      margin-top: 6px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      font-weight: 400;
      margin-bottom: 4px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    button {
      width: 100%;
      padding: 11px 14px;
      font-size: 16px;
      border-radius: var(--radius);
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }

    .primary {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .secondary {
      background: #e5e7eb;
      color: #111;
      border-color: #e5e7eb;
    }

    .danger {
      background: #dc2626;
      color: #fff;
      padding: 6px 10px;
      width: auto;
      font-size: 14px;
    }

    .collapse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding-bottom: 10px;
    }

    .collapse-arrow {
      font-size: 18px;
      margin-left: 8px;
    }

    .compact-row {
      padding: 10px 0;
      font-size: 16px;
      border-top: 1px solid var(--border);
    }

    .full-list {
      margin-top: 12px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px 4px 0 0;
      font-size: 12px;
      background: #e5e7eb;
      border-radius: 999px;
    }

    .filter-row {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      padding: 8px 0;
    }

    .filter-row input {
      width: 60px;
      text-align: center;
    }

    .plan {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
      margin-top: 16px;
    }

    .day {
      padding: 14px;
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .day img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: var(--radius);
      margin: 10px 0;
    }
  </style>
</head>

<body>

<h1>Meal Randomizer</h1>

<!-- ========================================================== -->
<!--       KARTE 1: GERICHT HINZUFÜGEN                          -->
<!-- ========================================================== -->

<div class="card">
  <h2>Gericht hinzufügen</h2>

  <div class="form-group first">
    <input id="name" type="text" placeholder="Name">
  </div>

  <div class="form-group">
    <label>Ernährungsform</label>
    <div class="checkbox-group" id="diet">
      <label><input type="checkbox" value="Fleisch"> Fleisch</label>
      <label><input type="checkbox" value="Vegetarisch"> Vegetarisch</label>
      <label><input type="checkbox" value="Vegan"> Vegan</label>
    </div>
  </div>

  <div class="form-group">
    <label>Aufwand</label>
    <div class="checkbox-group" id="effort">
      <label><input type="checkbox" value="Aufwand low"> low</label>
      <label><input type="checkbox" value="Aufwand medium"> medium</label>
      <label><input type="checkbox" value="Aufwand high"> high</label>
    </div>
  </div>

  <div class="form-group">
    <label>Nährstoffe</label>
    <div class="checkbox-group" id="nutri">
      <label><input type="checkbox" value="High Protein"> High Protein</label>
      <label><input type="checkbox" value="Low carb"> Low carb</label>
      <label><input type="checkbox" value="Low fat"> Low fat</label>
      <label><input type="checkbox" value="Cheat"> Cheat</label>
      <label><input type="checkbox" value="Healthy"> Healthy</label>
    </div>
  </div>

  <div class="form-group">
    <label>Eigene Kategorien</label>
    <input id="custom" type="text" placeholder="z.B. Schnell, Familie">
  </div>

  <div class="form-group">
    <label>Bild</label>
    <input id="image" type="file" accept="image/*">
  </div>

  <button class="primary" id="add">Speichern</button>
  <button class="secondary" id="clear">Alle löschen</button>

  <p id="msg" style="font-size:13px;color:green;"></p>
</div>

<!-- ========================================================== -->
<!--  KARTE 2: GESPEICHERTE GERICHTE                           -->
<!-- ========================================================== -->

<div class="card" id="mealsCard">

  <div class="collapse-header" id="mealsToggle">
    <h2>Gespeicherte Gerichte</h2>
    <span id="mealsArrow" class="collapse-arrow">►</span>
  </div>

  <div id="mealsCompact"></div>
  <div id="mealsFull" class="full-list" style="display:none;"></div>

</div>

<!-- ========================================================== -->
<!--  KARTE 3: RANDOMIZE NACH KATEGORIEN                        -->
<!-- ========================================================== -->

<div class="card" id="catCard">

  <div class="collapse-header" id="catToggle">
    <h2>Randomize nach Kategorien</h2>
    <span id="catArrow" class="collapse-arrow">►</span>
  </div>

  <div id="catCompact"></div>

  <div id="catFull" style="display:none; margin-top:12px;">
    <small>(Leer lassen = komplett zufällig)</small>
    <div id="filterFields" style="margin-top:12px;"></div>
  </div>

</div>

<!-- ========================================================== -->
<!--  KARTE 4: ANZAHL TAGE                                      -->
<!-- ========================================================== -->

<div class="card">
  <h2>Anzahl Tage für Randomizer</h2>

  <input id="days" type="number" min="1" value="5">

  <button class="primary" id="generate">Randomizer</button>
  <button class="secondary" id="export">Export als Bild</button>

  <p id="planMsg" style="font-size:13px;color:red;"></p>

  <div id="planContainer">
    <div id="plan" class="plan"></div>
  </div>
</div>

<!-- ========================================================== -->
<!-- JAVASCRIPT                                                 -->
<!-- ========================================================== -->

<script>
  let meals = JSON.parse(localStorage.getItem("meals") || "[]");
  let plan = [];
  let editId = null;

  const save = () => localStorage.setItem("meals", JSON.stringify(meals));

  function getAllTags() {
    const tags = new Set();
    meals.forEach(m => m.tags.forEach(t => tags.add(t)));
    return [...tags].sort();
  }

  function renderMeals() {
    const compact = document.getElementById("mealsCompact");
    const full = document.getElementById("mealsFull");

    if (meals.length === 0) {
      compact.innerHTML = `<div class="compact-row">Keine Gerichte vorhanden</div>`;
      full.innerHTML = "";
      renderFilterFields();
      return;
    }

    compact.innerHTML = `<div class="compact-row">• ${meals[0].name}</div>`;

    full.innerHTML = "";
    meals.forEach(m => {
      const row = document.createElement("div");
      row.className = "row";

      row.innerHTML = `
        <div>
          <strong>${m.name}</strong><br>
          ${m.tags.map(t => `<span class="tag">${t}</span>`).join("")}
        </div>
      `;

      const edit = document.createElement("button");
      edit.className = "secondary";
      edit.style.width = "auto";
      edit.style.marginRight = "6px";
      edit.textContent = "✏️";
      edit.onclick = () => startEdit(m.id);

      const del = document.createElement("button");
      del.className = "danger";
      del.textContent = "X";
      del.onclick = () => {
        meals = meals.filter(x => x.id !== m.id);
        save();
        renderMeals();
        renderFilterFields();
      };

      const right = document.createElement("div");
      right.style.display = "flex";
      right.appendChild(edit);
      right.appendChild(del);

      row.appendChild(right);
      full.appendChild(row);
    });

    renderFilterFields();
  }

  function renderFilterFields() {
    const compact = document.getElementById("catCompact");
    const container = document.getElementById("filterFields");

    const tags = getAllTags();

    if (tags.length === 0) {
      compact.innerHTML = `<div class="compact-row">Keine Kategorien vorhanden</div>`;
      container.innerHTML = "";
      return;
    }

    compact.innerHTML = `<div class="compact-row">• ${tags[0]}</div>`;

    container.innerHTML = "";
    tags.forEach(tag => {
      const div = document.createElement("div");
      div.className = "filter-row";
      div.innerHTML = `
        <span>${tag}</span>
        <input type="number" min="0" data-tag="${tag}">
      `;
      container.appendChild(div);
    });
  }

  function getChecked(id) {
    return [...document.querySelectorAll(`#${id} input:checked`)].map(c => c.value);
  }

  document.getElementById("add").onclick = () => {
    const name = document.getElementById("name").value.trim();
    if (!name) return alert("Name fehlt.");

    const tags = [
      ...getChecked("diet"),
      ...getChecked("effort"),
      ...getChecked("nutri"),
      ...document.getElementById("custom").value.split(",").map(x => x.trim()).filter(x => x),
    ];

    const file = document.getElementById("image").files[0];

    if (editId) {
      const meal = meals.find(m => m.id === editId);
      meal.name = name;
      meal.tags = tags;

      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          meal.image = reader.result;
          finishEdit();
        };
        reader.readAsDataURL(file);
      } else {
        finishEdit();
      }
      return;
    }

    if (file) {
      const reader = new FileReader();
      reader.onload = () => addMeal(name, tags, reader.result);
      reader.readAsDataURL(file);
    } else {
      addMeal(name, tags, null);
    }
  };

  function addMeal(name, tags, img) {
    meals.push({ id: crypto.randomUUID(), name, tags, image: img });
    save();
    clearForm();
    renderMeals();
  }

  function startEdit(id) {
    const meal = meals.find(m => m.id === id);
    editId = id;

    document.getElementById("name").value = meal.name;

    document.querySelectorAll("input[type=checkbox]").forEach(c => c.checked = false);
    meal.tags.forEach(t => {
      [...document.querySelectorAll("input[type=checkbox]")].forEach(box => {
        if (box.value === t) box.checked = true;
      });
    });

    document.getElementById("custom").value =
      meal.tags.filter(t =>
        !["Fleisch", "Vegetarisch", "Vegan",
          "Aufwand low", "Aufwand medium", "Aufwand high",
          "High Protein", "Low carb", "Low fat", "Cheat", "Healthy"
        ].includes(t)
      ).join(", ");

    document.getElementById("image").value = "";
    document.getElementById("add").textContent = "Änderungen speichern";
  }

  function finishEdit() {
    save();
    clearForm();
    renderMeals();
    editId = null;
    document.getElementById("add").textContent = "Speichern";
  }

  function clearForm() {
    document.getElementById("name").value = "";
    document.getElementById("custom").value = "";
    document.getElementById("image").value = "";
    document.querySelectorAll("input[type=checkbox]").forEach(c => c.checked = false);
  }

  document.getElementById("clear").onclick = () => {
    if (confirm("Alle löschen?")) {
      meals = [];
      save();
      renderMeals();
    }
  };

  document.getElementById("generate").onclick = () => {
    const days = parseInt(document.getElementById("days").value);
    const planMsg = document.getElementById("planMsg");
    planMsg.textContent = "";

    if (!days || days < 1) {
      planMsg.textContent = "Bitte gültige Anzahl Tage eingeben.";
      return;
    }

    if (meals.length === 0) {
      planMsg.textContent = "Keine Gerichte vorhanden.";
      return;
    }

    let desired = [];
    [...document.querySelectorAll("#filterFields input")].forEach(inp => {
      const v = parseInt(inp.value);
      if (v > 0) {
        for (let i = 0; i < v; i++) desired.push(inp.dataset.tag);
      }
    });

    while (desired.length < days) desired.push("RANDOM");
    desired = desired.slice(0, days);
    desired.sort(() => Math.random() - 0.5);

    plan = [];

    desired.forEach(tag => {
      let candidates =
        tag === "RANDOM"
          ? meals
          : meals.filter(m => m.tags.includes(tag));

      if (!candidates.length) candidates = meals;

      const chosen = candidates[Math.floor(Math.random() * candidates.length)];
      plan.push({ tag, meal: chosen });
    });

    renderPlan();
  };

  function reroll(i) {
    const tag = plan[i].tag;

    let candidates =
      tag === "RANDOM"
        ? meals
        : meals.filter(m => m.tags.includes(tag));

    if (!candidates.length) candidates = meals;

    plan[i].meal = candidates[Math.floor(Math.random() * candidates.length)];
    renderPlan();
  }

  function renderPlan() {
    const p = document.getElementById("plan");
    p.innerHTML = "";

    plan.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "day";

      div.innerHTML = `<strong>Tag ${idx + 1}</strong><br>`;

      if (item.meal.image)
        div.innerHTML += `<img src="${item.meal.image}">`;

      div.innerHTML += `${item.meal.name}<br>`;
      div.innerHTML += item.meal.tags.map(t => `<span class="tag">${t}</span>`).join("");

      const btn = document.createElement("button");
      btn.className = "secondary";
      btn.style.marginTop = "10px";
      btn.textContent = "Neu ziehen";
      btn.onclick = () => reroll(idx);

      div.appendChild(btn);
      p.appendChild(div);
    });
  }

  document.getElementById("export").onclick = () => {
    if (!plan.length) return;
    html2canvas(document.getElementById("planContainer")).then(canvas => {
      const a = document.createElement("a");
      a.download = "meal-plan.png";
      a.href = canvas.toDataURL();
      a.click();
    });
  };

  document.getElementById("mealsToggle").onclick = () => {
    const full = document.getElementById("mealsFull");
    const arrow = document.getElementById("mealsArrow");

    if (full.style.display === "none") {
      full.style.display = "block";
      arrow.textContent = "▼";
    } else {
      full.style.display = "none";
      arrow.textContent = "►";
    }
  };

  document.getElementById("catToggle").onclick = () => {
    const full = document.getElementById("catFull");
    const arrow = document.getElementById("catArrow");

    if (full.style.display === "none") {
      full.style.display = "block";
      arrow.textContent = "▼";
    } else {
      full.style.display = "none";
      arrow.textContent = "►";
    }
  };

  renderMeals();
  renderFilterFields();
  renderPlan();
</script>

</body>
</html>
