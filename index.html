<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Meal Randomizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --border: #e5e7eb;
      --text-dark: #111827;
      --radius: 12px;
      --shadow: 0 3px 10px rgba(0,0,0,0.08);
      --group-space: 20px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text-dark);
      max-width: 900px;
      margin-inline: auto;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 14px;
      font-weight: 700;
    }

    .card {
      background: var(--card-bg);
      padding: 18px;
      border-radius: var(--radius);
      margin-top: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .group {
      margin-top: var(--group-space);
    }

    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-sizing: border-box;
    }

    button {
      padding: 11px 14px;
      font-size: 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      border: 1px solid var(--border);
      width: 100%;
      margin-top: 6px;
    }

    .primary {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .primary:hover {
      background: var(--primary-hover);
    }

    .secondary {
      background: #e5e7eb;
      border-color: #e5e7eb;
    }

    .danger {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
      width: auto;
      padding: 6px 10px;
      margin: 0;
    }

    /* Filter toggle */
    .filter-toggle {
      margin-top: 16px;
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
      font-size: 16px;
    }

    .filter-section {
      margin-top: 12px;
      padding: 14px;
      background: #f9fafb;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      display: none;
    }

    .filter-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }

    .filter-row label {
      font-weight: 400;
      margin-bottom: 0;
    }

    .filter-row input {
      width: 60px;
      text-align: center;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      font-weight: 400;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px 4px 0 0;
      font-size: 12px;
      background: #e5e7eb;
      border-radius: 999px;
    }

    .plan {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
      margin-top: 16px;
    }

    .day {
      background: var(--card-bg);
      padding: 14px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .day img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: var(--radius);
      margin: 10px 0;
    }

  </style>
</head>

<body>

<h1>Meal Randomizer</h1>

<!-- ADD MEAL -->
<div class="card">
  <h2>Gericht hinzufügen</h2>

  <div class="group" style="margin-top:0;">
    <label>Name</label>
    <input id="name" type="text">
  </div>

  <div class="group">
    <label>Ernährungsform</label>
    <div class="checkbox-group" id="diet">
      <label><input type="checkbox" value="Fleisch"> Fleisch</label>
      <label><input type="checkbox" value="Vegetarisch"> Vegetarisch</label>
      <label><input type="checkbox" value="Vegan"> Vegan</label>
    </div>
  </div>

  <div class="group">
    <label>Aufwand</label>
    <div class="checkbox-group" id="effort">
      <label><input type="checkbox" value="Aufwand low"> low</label>
      <label><input type="checkbox" value="Aufwand medium"> medium</label>
      <label><input type="checkbox" value="Aufwand high"> high</label>
    </div>
  </div>

  <div class="group">
    <label>Nährstoffe</label>
    <div class="checkbox-group" id="nutri">
      <label><input type="checkbox" value="High Protein"> High Protein</label>
      <label><input type="checkbox" value="Low carb"> Low carb</label>
      <label><input type="checkbox" value="Low fat"> Low fat</label>
      <label><input type="checkbox" value="Cheat"> Cheat</label>
      <label><input type="checkbox" value="Healthy"> Healthy</label>
    </div>
  </div>

  <div class="group">
    <label>Eigene Kategorien</label>
    <input id="custom" type="text" placeholder="z.B. Schnell, Familie">
  </div>

  <div class="group">
    <label>Bild</label>
    <input id="image" type="file" accept="image/*">
  </div>

  <button class="primary" id="add">Speichern</button>
  <button class="secondary" id="clear">Alle löschen</button>

  <p id="msg" style="font-size:13px;color:green;"></p>
</div>


<!-- MEAL LIST -->
<div class="card">
  <h2>Gespeicherte Gerichte (<span id="count">0</span>)</h2>
  <div id="list"></div>
</div>

<!-- RANDOMIZER -->
<div class="card">
  <h2>Wochenplan</h2>

  <label>Anzahl Tage</label>
  <input id="days" type="number" min="1" value="5">

  <div class="filter-toggle" id="toggleFilter">▼ Filter anzeigen (optional)</div>

  <div class="filter-section" id="filterSection">
    <strong>Kategorie-Verteilung</strong><br>
    <small>(Leer lassen = komplett zufällig)</small>

    <div id="filterFields" style="margin-top:12px;"></div>
  </div>

  <button class="primary" id="generate">Randomizer</button>
  <button class="secondary" id="export">Export als Bild</button>

  <p id="planMsg" style="font-size:13px;color:red;"></p>

  <div id="planContainer">
    <div id="plan" class="plan"></div>
  </div>
</div>

<script>
  /* ============================================================
     DATENMODELL
  ============================================================ */
  const key = "meals";
  let meals = JSON.parse(localStorage.getItem(key) || "[]");
  let plan = [];

  /* ============================================================
     HILFSFUNKTIONEN
  ============================================================ */
  const id = () => crypto.randomUUID();

  function save() {
    localStorage.setItem(key, JSON.stringify(meals));
  }

  function getAllTags() {
    const tags = new Set();
    meals.forEach(m => m.tags.forEach(t => tags.add(t)));
    return [...tags].sort();
  }

  /* ============================================================
     FILTER UI AUFBAUEN
  ============================================================ */
  function renderFilterFields() {
    const container = document.getElementById("filterFields");
    container.innerHTML = "";

    const tags = getAllTags();
    tags.forEach(tag => {
      const div = document.createElement("div");
      div.className = "filter-row";

      div.innerHTML = `
        <label>${tag}</label>
        <input type="number" min="0" value="" data-tag="${tag}">
      `;

      container.appendChild(div);
    });
  }

  /* ============================================================
     MEALS ANZEIGEN
  ============================================================ */
  function renderMeals() {
    const list = document.getElementById("list");
    list.innerHTML = "";
    document.getElementById("count").textContent = meals.length;

    meals.forEach(m => {
      const row = document.createElement("div");
      row.className = "row";

      const left = document.createElement("div");
      left.innerHTML = `<strong>${m.name}</strong><br>` +
        m.tags.map(t => `<span class="tag">${t}</span>`).join("");

      const del = document.createElement("button");
      del.textContent = "X";
      del.className = "danger";
      del.onclick = () => {
        meals = meals.filter(x => x.id !== m.id);
        save();
        renderMeals();
        renderFilterFields();
        renderPlan();
      };

      row.appendChild(left);
      row.appendChild(del);
      list.appendChild(row);
    });

    renderFilterFields();
  }

  /* ============================================================
     MEAL HINZUFÜGEN
  ============================================================ */
  function getChecked(id) {
    return [...document.getElementById(id).querySelectorAll("input:checked")].map(c => c.value);
  }

  document.getElementById("add").onclick = () => {
    const name = document.getElementById("name").value.trim();
    if (!name) return alert("Name fehlt.");

    const tags = [
      ...getChecked("diet"),
      ...getChecked("effort"),
      ...getChecked("nutri"),
      ...document.getElementById("custom").value.split(",").map(x => x.trim()).filter(x => x)
    ];

    const file = document.getElementById("image").files[0];

    if (file) {
      const reader = new FileReader();
      reader.onload = () => addMeal(name, tags, reader.result);
      reader.readAsDataURL(file);
    } else {
      addMeal(name, tags, null);
    }
  };

  function addMeal(name, tags, img) {
    meals.push({ id: id(), name, tags, image: img });
    save();
    renderMeals();

    document.getElementById("name").value = "";
    document.getElementById("custom").value = "";
    document.getElementById("image").value = "";
    document.querySelectorAll("input[type=checkbox]").forEach(c => (c.checked = false));

    const msg = document.getElementById("msg");
    msg.textContent = "Gericht gespeichert.";
    setTimeout(() => (msg.textContent = ""), 2000);
  }

  /* ============================================================
     ALLE LÖSCHEN
  ============================================================ */
  document.getElementById("clear").onclick = () => {
    if (confirm("Alle löschen?")) {
      meals = [];
      save();
      renderMeals();
      plan = [];
      renderPlan();
    }
  };

  /* ============================================================
     RANDOMIZER
  ============================================================ */
  document.getElementById("generate").onclick = () => {
    const d = parseInt(document.getElementById("days").value);
    const planMsg = document.getElementById("planMsg");

    if (!d || d < 1) {
      planMsg.textContent = "Bitte eine gültige Anzahl Tage eingeben.";
      return;
    }

    if (!meals.length) {
      planMsg.textContent = "Bitte zuerst mindestens ein Gericht speichern.";
      return;
    }

    planMsg.textContent = "";

    const filterInputs = [...document.querySelectorAll("#filterFields input")];
    let desired = [];

    filterInputs.forEach(inp => {
      const tag = inp.dataset.tag;
      const v = parseInt(inp.value);
      if (v > 0) {
        for (let i = 0; i < v; i++) desired.push(tag);
      }
    });

    const randomFillNeeded = d - desired.length;

    for (let i = 0; i < randomFillNeeded; i++) {
      desired.push("RANDOM");
    }

    desired.sort(() => Math.random() - 0.5);

    plan = [];

    desired.forEach(tag => {
      let candidates =
        tag === "RANDOM"
          ? meals
          : meals.filter(m => m.tags.includes(tag));

      if (!candidates.length) {
        candidates = meals;
      }

      const chosen = candidates[Math.floor(Math.random() * candidates.length)];
      plan.push({ tag, meal: chosen });
    });

    renderPlan();
  };

  /* ============================================================
     RESET EINZELNER TAGE
  ============================================================ */
  function reroll(i) {
    const targetTag = plan[i].tag;

    let candidates =
      targetTag === "RANDOM"
        ? meals
        : meals.filter(m => m.tags.includes(targetTag));

    if (!candidates.length) {
      candidates = meals;
    }

    plan[i].meal = candidates[Math.floor(Math.random() * candidates.length)];
    renderPlan();
  }

  /* ============================================================
     PLAN ANZEIGEN
  ============================================================ */
  function renderPlan() {
    const p = document.getElementById("plan");
    p.innerHTML = "";

    plan.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "day";

      div.innerHTML = `<strong>Tag ${idx + 1}</strong><br>`;

      if (item.meal.image) {
        div.innerHTML += `<img src="${item.meal.image}">`;
      }

      div.innerHTML += `<div>${item.meal.name}</div>`;
      div.innerHTML += item.meal.tags
        .map(t => `<span class='tag'>${t}</span>`)
        .join("");

      const btn = document.createElement("button");
      btn.className = "secondary";
      btn.textContent = "Neu ziehen";
      btn.onclick = () => reroll(idx);

      div.appendChild(btn);
      p.appendChild(div);
    });
  }

  /* ============================================================
     EXPORT
  ============================================================ */
  document.getElementById("export").onclick = () => {
    if (!plan.length) return;
    html2canvas(document.getElementById("planContainer")).then(canvas => {
      const a = document.createElement("a");
      a.download = "meal-plan.png";
      a.href = canvas.toDataURL();
      a.click();
    });
  };

  /* ============================================================
     FILTER TOGGLE
  ============================================================ */
  document.getElementById("toggleFilter").onclick = () => {
    const sec = document.getElementById("filterSection");
    const toggle = document.getElementById("toggleFilter");

    if (sec.style.display === "none" || sec.style.display === "") {
      sec.style.display = "block";
      toggle.textContent = "▲ Filter ausblenden";
    } else {
      sec.style.display = "none";
      toggle.textContent = "▼ Filter anzeigen (optional)";
    }
  };

  /* INIT */
  renderMeals();
  renderPlan();
</script>

</body>
</html>
